<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice & Statement Extractor – ExtractSuite</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- PDF.js for PDF text extraction -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #34c759 0%, #30d158 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .frosted-nav {
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            background-color: rgba(255, 255, 255, 0.72);
        }
        
        .upload-area {
            border: 2px dashed #d1d1d6;
            transition: all 0.3s ease;
        }
        
        .upload-area.dragover {
            border-color: #34c759;
            background-color: rgba(52, 199, 89, 0.05);
        }
        
        .spinner {
            border: 3px solid #f5f5f7;
            border-top: 3px solid #34c759;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .fade-in {
            animation: fadeIn 0.4s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .user-dropdown {
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
        }
        
        .user-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        .toast {
            animation: toastSlideIn 0.3s ease, toastSlideOut 0.3s ease 2.7s forwards;
        }
        
        @keyframes toastSlideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes toastSlideOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(20px); }
        }
        
        .mode-toggle {
            position: relative;
            background: #f5f5f7;
            border-radius: 12px;
            padding: 4px;
        }
        
        .mode-btn {
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .mode-btn.active {
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .ai-badge {
            background: linear-gradient(135deg, #5856d6, #af52de);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 4px;
        }
        
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        
        .modal-content {
            animation: modalSlideIn 0.3s ease;
        }
        
        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-20px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        
        .credit-card {
            background: linear-gradient(135deg, #1d1d1f 0%, #3d3d3f 100%);
            border-radius: 16px;
            padding: 24px;
            color: white;
        }
        
        .credit-option {
            border: 2px solid #e5e5e7;
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .credit-option:hover {
            border-color: #0071e3;
        }
        
        .credit-option.selected {
            border-color: #0071e3;
            background: rgba(0, 113, 227, 0.05);
        }
        
        .doc-type-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .doc-type-invoice {
            background: rgba(52, 199, 89, 0.1);
            color: #34c759;
        }
        
        .doc-type-statement {
            background: rgba(0, 113, 227, 0.1);
            color: #0071e3;
        }
        
        .transaction-row:nth-child(even) {
            background: rgba(0,0,0,0.02);
        }
        
        .transaction-credit {
            color: #34c759;
        }
        
        .transaction-debit {
            color: #ff3b30;
        }
    </style>
</head>
<body class="bg-[#f5f5f7] text-[#1d1d1f]">
    
    <!-- Navigation -->
    <nav class="frosted-nav fixed top-0 left-0 right-0 z-50 border-b border-gray-200/50">
        <div class="max-w-[980px] mx-auto px-6 h-14 flex items-center justify-between">
            <a href="index.html" class="flex items-center gap-2">
                <svg class="w-8 h-8" viewBox="0 0 32 32" fill="none">
                    <rect width="32" height="32" rx="8" fill="url(#logo-gradient)"/>
                    <path d="M9 12h14M9 16h10M9 20h14" stroke="white" stroke-width="2" stroke-linecap="round"/>
                    <defs>
                        <linearGradient id="logo-gradient" x1="0" y1="0" x2="32" y2="32">
                            <stop stop-color="#0071e3"/>
                            <stop offset="1" stop-color="#40c8e0"/>
                        </linearGradient>
                    </defs>
                </svg>
                <span class="text-xl font-semibold" style="background: linear-gradient(135deg, #0071e3 0%, #40c8e0 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">ExtractSuite</span>
            </a>
            
            <div class="hidden md:flex items-center gap-8">
                <a href="index.html#tools" class="text-sm text-[#1d1d1f] hover:text-[#0071e3] transition-colors">Tools</a>
                <a href="index.html#how-it-works" class="text-sm text-[#1d1d1f] hover:text-[#0071e3] transition-colors">How It Works</a>
                <a href="index.html#pricing" class="text-sm text-[#1d1d1f] hover:text-[#0071e3] transition-colors">Pricing</a>
            </div>
            
            <div class="hidden md:flex items-center gap-3" id="auth-buttons">
                <div id="logged-out-buttons" class="flex items-center gap-3">
                    <button onclick="window.location.href='index.html#pricing'" class="text-sm text-[#1d1d1f] hover:text-[#0071e3] transition-colors font-medium">
                        Sign In
                    </button>
                    <button onclick="window.location.href='index.html#pricing'" class="bg-[#0071e3] text-white text-sm font-medium px-5 py-2 rounded-full hover:bg-[#0077ED] transition-colors">
                        Get Started
                    </button>
                </div>
                
                <div id="logged-in-buttons" class="hidden relative">
                    <button onclick="toggleUserDropdown()" class="flex items-center gap-2 text-sm font-medium hover:text-[#0071e3] transition-colors">
                        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-[#34c759] to-[#30d158] flex items-center justify-center text-white text-xs font-semibold" id="user-avatar">
                            U
                        </div>
                        <span id="user-name" class="hidden sm:inline">User</span>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </button>
                    
                    <div id="user-dropdown" class="user-dropdown absolute right-0 top-12 w-64 bg-white rounded-2xl shadow-2xl border border-gray-100 overflow-hidden z-50">
                        <div class="p-4 border-b border-gray-100">
                            <p class="font-semibold text-sm" id="dropdown-name">User</p>
                            <p class="text-xs text-[#86868b]" id="dropdown-email">user@email.com</p>
                        </div>
                        <div class="p-2">
                            <div class="px-3 py-2 rounded-lg bg-[#f5f5f7] mb-2">
                                <p class="text-xs text-[#86868b]">Monthly Usage</p>
                                <div class="flex items-center justify-between mt-1">
                                    <span class="text-sm font-semibold" id="usage-count">0 / 10</span>
                                    <span class="text-xs px-2 py-0.5 rounded-full bg-[#34c759]/10 text-[#34c759] font-medium" id="user-plan">Free</span>
                                </div>
                                <div class="w-full h-1.5 bg-gray-200 rounded-full mt-2">
                                    <div class="h-full bg-[#34c759] rounded-full transition-all" id="usage-bar" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="px-3 py-2 rounded-lg bg-gradient-to-r from-[#5856d6]/10 to-[#af52de]/10 mb-2">
                                <p class="text-xs text-[#5856d6]">AI Credits</p>
                                <div class="flex items-center justify-between mt-1">
                                    <span class="text-sm font-semibold" id="ai-credits">0</span>
                                    <button onclick="openCreditsModal()" class="text-xs px-2 py-0.5 rounded-full bg-[#5856d6] text-white font-medium hover:bg-[#4745c5] transition-colors">
                                        Buy More
                                    </button>
                                </div>
                            </div>
                            <a href="index.html#pricing" class="flex items-center gap-3 px-3 py-2 text-sm text-[#1d1d1f] hover:bg-[#f5f5f7] rounded-lg transition-colors">
                                <svg class="w-5 h-5 text-[#86868b]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
                                </svg>
                                Upgrade Plan
                            </a>
                            <button onclick="signOut()" class="w-full flex items-center gap-3 px-3 py-2 text-sm text-[#ff3b30] hover:bg-[#f5f5f7] rounded-lg transition-colors">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                                </svg>
                                Sign Out
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>
    
    <!-- Hero Section -->
    <section class="pt-24 pb-12 px-6 bg-white">
        <div class="max-w-[980px] mx-auto text-center">
            <div class="inline-flex items-center gap-2 px-4 py-2 bg-[#34c759]/10 rounded-full mb-6">
                <svg class="w-5 h-5 text-[#34c759]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <span class="text-sm font-semibold text-[#34c759]">Universal Document Extractor</span>
            </div>
            
            <h1 class="text-5xl md:text-6xl font-semibold mb-6">
                Extract any document.<br>
                <span class="gradient-text">Any country. Any format.</span>
            </h1>
            
            <p class="text-xl text-[#6e6e73] max-w-2xl mx-auto mb-8">
                Upload invoices or bank statements from anywhere in the world. Get structured CSV data with intelligent field detection.
            </p>
        </div>
    </section>
    
    <!-- Upload Section -->
    <section class="py-12 px-6">
        <div class="max-w-[980px] mx-auto">
            
            <!-- Upload Area -->
            <div id="upload-section" class="bg-white rounded-3xl p-8 md:p-12 shadow-lg">
                
                <!-- Extraction Mode Toggle -->
                <div class="flex justify-center mb-8">
                    <div class="mode-toggle flex">
                        <button id="mode-standard" onclick="setExtractionMode('standard')" class="mode-btn active">
                            Standard
                        </button>
                        <button id="mode-ai" onclick="setExtractionMode('ai')" class="mode-btn flex items-center">
                            AI-Powered
                            <span class="ai-badge">PRO</span>
                        </button>
                    </div>
                </div>
                
                <!-- Mode Description -->
                <div class="text-center mb-6">
                    <p id="mode-description" class="text-sm text-[#6e6e73]">
                        Standard extraction uses advanced pattern matching for invoices & bank statements worldwide. Works best with digital PDFs.
                    </p>
                </div>
                
                <div id="upload-area" class="upload-area rounded-2xl p-12 text-center cursor-pointer">
                    <input type="file" id="file-input" accept=".pdf" class="hidden">
                    
                    <svg class="w-16 h-16 mx-auto text-[#34c759] mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                    </svg>
                    
                    <h3 class="text-2xl font-semibold mb-2">Drop your document here</h3>
                    <p class="text-[#6e6e73] mb-4">Invoices, Bank Statements, Receipts</p>
                    <p class="text-sm text-[#86868b]">PDF only • Max 50MB • Any language</p>
                </div>
                
                <!-- Selected File Info -->
                <div id="file-info" class="hidden mt-6 p-4 bg-[#f5f5f7] rounded-xl flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <svg class="w-10 h-10 text-[#ff3b30]" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z"/>
                            <path d="M14 2v6h6M10 17h4M10 13h4M10 9h1" stroke="white" stroke-width="1"/>
                        </svg>
                        <div>
                            <p class="font-semibold text-sm" id="file-name">invoice.pdf</p>
                            <p class="text-xs text-[#86868b]" id="file-size">2.4 MB</p>
                        </div>
                    </div>
                    <button onclick="clearFile()" class="text-[#ff3b30] text-sm font-medium hover:underline">Remove</button>
                </div>
                
                <!-- Extract Button -->
                <button id="extract-btn" onclick="extractDocument()" class="hidden w-full mt-6 py-4 bg-[#34c759] text-white font-semibold rounded-full hover:bg-[#30d158] transition-colors text-lg">
                    Extract Document Data
                </button>
            </div>
            
            <!-- Processing State -->
            <div id="processing-section" class="hidden bg-white rounded-3xl p-12 shadow-lg text-center">
                <div class="spinner mx-auto mb-6"></div>
                <h3 class="text-2xl font-semibold mb-2">Extracting data...</h3>
                <p class="text-[#6e6e73] mb-4" id="processing-status">Reading PDF content...</p>
                <div class="max-w-xs mx-auto">
                    <div class="w-full h-2 bg-gray-200 rounded-full overflow-hidden">
                        <div id="progress-bar" class="h-full bg-[#34c759] rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            
            <!-- Results Section -->
            <div id="results-section" class="hidden bg-white rounded-3xl p-8 md:p-12 shadow-lg fade-in">
                <div class="flex items-center justify-between mb-8">
                    <div class="flex items-center gap-3">
                        <svg class="w-10 h-10 text-[#34c759]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <div>
                            <h3 class="text-2xl font-semibold">Extraction Complete!</h3>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="text-sm text-[#6e6e73]" id="extraction-mode-label">Standard extraction</span>
                                <span id="doc-type-badge" class="doc-type-badge doc-type-invoice">
                                    <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4z"/></svg>
                                    Invoice
                                </span>
                            </div>
                        </div>
                    </div>
                    <button onclick="resetExtractor()" class="text-sm text-[#0071e3] font-medium hover:underline">
                        Extract Another
                    </button>
                </div>
                
                <!-- Document Details -->
                <div class="bg-[#f5f5f7] rounded-2xl p-6 mb-6">
                    <h4 class="font-semibold mb-4" id="details-title">Document Details</h4>
                    <div class="space-y-3" id="document-details">
                        <!-- Will be populated dynamically -->
                    </div>
                </div>
                
                <!-- Line Items / Transactions Table -->
                <div id="items-section" class="bg-[#f5f5f7] rounded-2xl p-6 mb-8">
                    <h4 class="font-semibold mb-4" id="items-title">Line Items</h4>
                    <div class="overflow-x-auto">
                        <table class="w-full" id="items-table">
                            <thead id="items-thead">
                                <tr class="border-b border-gray-300">
                                    <th class="text-left text-xs font-semibold text-[#86868b] pb-3">Description</th>
                                    <th class="text-right text-xs font-semibold text-[#86868b] pb-3">Qty</th>
                                    <th class="text-right text-xs font-semibold text-[#86868b] pb-3">Unit Price</th>
                                    <th class="text-right text-xs font-semibold text-[#86868b] pb-3">Amount</th>
                                </tr>
                            </thead>
                            <tbody id="items-tbody">
                                <!-- Will be populated dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Export Buttons -->
                <div class="flex flex-col sm:flex-row gap-4">
                    <button onclick="downloadCSV()" class="flex-1 py-3 px-6 bg-[#34c759] text-white font-semibold rounded-full hover:bg-[#30d158] transition-colors flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        Download CSV
                    </button>
                    <button onclick="downloadExcel()" class="flex-1 py-3 px-6 bg-[#0071e3] text-white font-semibold rounded-full hover:bg-[#0077ED] transition-colors flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        Download Excel
                    </button>
                    <button onclick="downloadJSON()" class="flex-1 py-3 px-6 border-2 border-[#0071e3] text-[#0071e3] font-semibold rounded-full hover:bg-[#0071e3] hover:text-white transition-colors flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        Download JSON
                    </button>
                </div>
            </div>
            
            <!-- Error Section -->
            <div id="error-section" class="hidden bg-white rounded-3xl p-12 shadow-lg text-center fade-in">
                <svg class="w-16 h-16 mx-auto text-[#ff3b30] mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <h3 class="text-2xl font-semibold mb-2">Extraction Failed</h3>
                <p class="text-[#6e6e73] mb-6" id="error-message">Something went wrong. Please try again.</p>
                <button onclick="resetExtractor()" class="bg-[#0071e3] text-white font-medium px-6 py-3 rounded-full hover:bg-[#0077ED] transition-colors">
                    Try Again
                </button>
            </div>
            
        </div>
    </section>
    
    <!-- Buy Credits Modal -->
    <div id="credits-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
        <div class="modal-overlay absolute inset-0" onclick="closeCreditsModal()"></div>
        <div class="modal-content relative bg-white rounded-3xl shadow-2xl w-full max-w-lg p-8">
            <button onclick="closeCreditsModal()" class="absolute top-4 right-4 p-2 hover:bg-[#f5f5f7] rounded-full transition-colors">
                <svg class="w-5 h-5 text-[#86868b]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
            
            <div class="text-center mb-6">
                <div class="w-16 h-16 mx-auto mb-4 rounded-2xl bg-gradient-to-br from-[#5856d6] to-[#af52de] flex items-center justify-center">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                </div>
                <h2 class="text-2xl font-semibold">Buy AI Credits</h2>
                <p class="text-sm text-[#6e6e73] mt-1">Power up your extractions with AI</p>
            </div>
            
            <!-- Current Credits -->
            <div class="credit-card mb-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-400">Current Balance</p>
                        <p class="text-3xl font-bold" id="modal-credits">0</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-gray-400">AI Credits</p>
                        <p class="text-xs text-gray-500">1 credit = 1 AI extraction</p>
                    </div>
                </div>
            </div>
            
            <!-- Credit Options -->
            <div class="space-y-3 mb-6">
                <div class="credit-option selected" onclick="selectCreditOption(this, 10, 5)">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="font-semibold">10 Credits</p>
                            <p class="text-sm text-[#6e6e73]">$0.50 per credit</p>
                        </div>
                        <p class="text-xl font-bold">$5</p>
                    </div>
                </div>
                <div class="credit-option" onclick="selectCreditOption(this, 50, 20)">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="font-semibold">50 Credits</p>
                            <p class="text-sm text-[#6e6e73]">$0.40 per credit</p>
                        </div>
                        <div class="text-right">
                            <p class="text-xl font-bold">$20</p>
                            <p class="text-xs text-[#34c759] font-medium">Save 20%</p>
                        </div>
                    </div>
                </div>
                <div class="credit-option" onclick="selectCreditOption(this, 100, 35)">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="font-semibold">100 Credits</p>
                            <p class="text-sm text-[#6e6e73]">$0.35 per credit</p>
                        </div>
                        <div class="text-right">
                            <p class="text-xl font-bold">$35</p>
                            <p class="text-xs text-[#34c759] font-medium">Save 30%</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <button onclick="purchaseCredits()" class="w-full py-3 px-6 bg-gradient-to-r from-[#5856d6] to-[#af52de] text-white font-semibold rounded-full hover:opacity-90 transition-opacity">
                Purchase Credits
            </button>
            
            <p class="text-xs text-[#86868b] text-center mt-4">
                Secure payment powered by Stripe
            </p>
        </div>
    </div>
    
    <!-- Toast Container -->
    <div id="toast-container" class="fixed bottom-6 left-1/2 -translate-x-1/2 z-50"></div>
    
    <script>
        // Set PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        // Groq API Configuration - Using Llama 4 Maverick
        const GROQ_API_KEY = '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';
        const GROQ_API_URL = 'https://api.groq.com/openai/v1/chat/completions';
        const TEXT_MODEL = 'meta-llama/llama-4-maverick-17b-128e-instruct';
        
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCynWQ_JKc07eab18k9qQeXp7azvCdv0WI",
            authDomain: "extract-suite.firebaseapp.com",
            projectId: "extract-suite",
            storageBucket: "extract-suite.firebasestorage.app",
            messagingSenderId: "511007996472",
            appId: "1:511007996472:web:0eaf56996f281d2be504cd",
            measurementId: "G-JV61MMF18H"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        let currentUser = null;
        let selectedFile = null;
        let extractedData = null;
        let extractionMode = 'standard';
        let selectedCredits = { amount: 10, price: 5 };
        let pdfTextItems = [];
        let pdfFullText = '';
        
        // ============================================
        // GLOBAL NUMBER FORMAT CONFIGURATIONS
        // ============================================
        const LOCALE_CONFIGS = {
            // European (comma decimal)
            EU: { decimal: ',', thousand: '.', regex: /\d{1,3}(?:\.\d{3})*,\d{1,2}/ },
            // US/UK (dot decimal)
            US: { decimal: '.', thousand: ',', regex: /\d{1,3}(?:,\d{3})*\.\d{1,2}/ },
            // Swiss (apostrophe thousand)
            CH: { decimal: '.', thousand: "'", regex: /\d{1,3}(?:'\d{3})*\.\d{1,2}/ },
            // Indian (lakhs/crores)
            IN: { decimal: '.', thousand: ',', regex: /\d{1,2}(?:,\d{2})*(?:,\d{3})?\.\d{1,2}/ },
            // Plain (no thousand separator)
            PLAIN: { decimal: '.', thousand: '', regex: /\d+\.?\d*/ }
        };

        // Currency detection patterns
        const CURRENCY_PATTERNS = {
            USD: /\$|USD|US\s*Dollar/i,
            EUR: /€|EUR|Euro/i,
            GBP: /£|GBP|Pound\s*Sterling/i,
            JPY: /¥|JPY|Yen/i,
            CNY: /¥|CNY|RMB|Yuan|人民币/i,
            INR: /₹|INR|Rs\.?|Rupee/i,
            CHF: /CHF|Fr\.|Franc/i,
            AUD: /A\$|AUD/i,
            CAD: /C\$|CAD/i,
            BRL: /R\$|BRL|Real/i,
            MXN: /MX\$|MXN|Peso/i,
            KRW: /₩|KRW|Won/i,
            RUB: /₽|RUB|Ruble/i,
            SEK: /SEK|kr/i,
            NOK: /NOK|kr/i,
            DKK: /DKK|kr/i,
            PLN: /PLN|zł/i,
            ZAR: /ZAR|R\s/i,
            AED: /AED|Dirham/i,
            SAR: /SAR|Riyal/i,
            SGD: /S\$|SGD/i,
            HKD: /HK\$|HKD/i,
            THB: /฿|THB|Baht/i,
            MYR: /RM|MYR|Ringgit/i,
            IDR: /Rp|IDR|Rupiah/i,
            PHP: /₱|PHP|Peso/i,
            VND: /₫|VND|Dong/i,
            TRY: /₺|TRY|TL|Lira/i,
            ILS: /₪|ILS|Shekel/i,
            EGP: /EGP|E£/i,
            NGN: /₦|NGN|Naira/i,
            KES: /KES|KSh/i,
            CZK: /CZK|Kč/i,
            HUF: /HUF|Ft/i,
            RON: /RON|lei/i,
            BGN: /BGN|лв/i,
            HRK: /HRK|kn/i,
            UAH: /₴|UAH|грн/i
        };

        // Bank statement keywords in multiple languages
        const BANK_STATEMENT_KEYWORDS = [
            // English
            'bank statement', 'account statement', 'statement of account', 'transaction history',
            'opening balance', 'closing balance', 'account number', 'account holder',
            'credit', 'debit', 'withdrawal', 'deposit', 'transfer', 'balance',
            // German
            'kontoauszug', 'kontobewegungen', 'anfangssaldo', 'endsaldo', 'kontonummer',
            'gutschrift', 'lastschrift', 'überweisung', 'einzahlung', 'auszahlung',
            // French
            'relevé de compte', 'relevé bancaire', 'solde initial', 'solde final',
            'numéro de compte', 'crédit', 'débit', 'virement',
            // Spanish
            'extracto bancario', 'estado de cuenta', 'saldo inicial', 'saldo final',
            'número de cuenta', 'crédito', 'débito', 'transferencia',
            // Portuguese
            'extrato bancário', 'saldo inicial', 'saldo final', 'número da conta',
            // Italian
            'estratto conto', 'saldo iniziale', 'saldo finale', 'numero conto',
            // Dutch
            'bankafschrift', 'rekeningafschrift', 'beginsaldo', 'eindsaldo', 'rekeningnummer',
            // Swedish/Norwegian/Danish
            'kontoutdrag', 'kontoutskrift', 'ingående saldo', 'utgående saldo',
            // Polish
            'wyciąg bankowy', 'saldo początkowe', 'saldo końcowe', 'numer konta',
            // Russian
            'выписка', 'начальный остаток', 'конечный остаток', 'номер счета',
            // Arabic
            'كشف حساب', 'رصيد افتتاحي', 'رصيد ختامي',
            // Chinese
            '银行对账单', '账户余额', '期初余额', '期末余额',
            // Japanese
            '取引明細', '口座番号', '残高',
            // Hindi
            'बैंक स्टेटमेंट', 'खाता संख्या', 'शेष राशि'
        ];

        // Invoice keywords in multiple languages
        const INVOICE_KEYWORDS = [
            // English
            'invoice', 'bill', 'tax invoice', 'commercial invoice', 'proforma',
            'invoice number', 'invoice date', 'due date', 'payment terms',
            'subtotal', 'total', 'tax', 'vat', 'gst', 'discount',
            // German
            'rechnung', 'rechnungsnummer', 'rechnungsdatum', 'fälligkeitsdatum',
            'nettobetrag', 'bruttobetrag', 'mwst', 'mehrwertsteuer', 'zwischensumme',
            // French
            'facture', 'numéro de facture', 'date de facture', 'date d\'échéance',
            'sous-total', 'total', 'tva', 'montant ht', 'montant ttc',
            // Spanish
            'factura', 'número de factura', 'fecha de factura', 'fecha de vencimiento',
            'subtotal', 'total', 'iva', 'importe',
            // Portuguese
            'fatura', 'nota fiscal', 'número da fatura', 'data de vencimento',
            // Italian
            'fattura', 'numero fattura', 'data fattura', 'scadenza', 'iva',
            // Dutch
            'factuur', 'factuurnummer', 'factuurdatum', 'btw', 'totaalbedrag',
            // Polish
            'faktura', 'numer faktury', 'data faktury', 'vat', 'kwota',
            // Russian
            'счет', 'счет-фактура', 'номер счета', 'дата счета', 'ндс',
            // Arabic
            'فاتورة', 'رقم الفاتورة', 'ضريبة',
            // Chinese
            '发票', '发票号码', '发票日期', '增值税', '总计',
            // Japanese
            '請求書', '請求書番号', '消費税', '合計',
            // Hindi
            'चालान', 'बिल', 'कुल राशि'
        ];

        // Auth State Observer
        auth.onAuthStateChanged((user) => {
            currentUser = user;
            updateUIForUser(user);
        });
        
        function updateUIForUser(user) {
            const loggedOutButtons = document.getElementById('logged-out-buttons');
            const loggedInButtons = document.getElementById('logged-in-buttons');
            const userAvatar = document.getElementById('user-avatar');
            const userName = document.getElementById('user-name');
            
            if (user) {
                loggedOutButtons.classList.add('hidden');
                loggedInButtons.classList.remove('hidden');
                
                const displayName = user.displayName || user.email;
                userAvatar.textContent = displayName.charAt(0).toUpperCase();
                userName.textContent = displayName.split(' ')[0];
                
                loadUserDataForDropdown(user.uid);
            } else {
                loggedOutButtons.classList.remove('hidden');
                loggedInButtons.classList.add('hidden');
            }
        }
        
        async function loadUserDataForDropdown(userId) {
            const userDoc = await db.collection('users').doc(userId).get();
            
            if (userDoc.exists) {
                const userData = userDoc.data();
                document.getElementById('dropdown-name').textContent = userData.displayName;
                document.getElementById('dropdown-email').textContent = userData.email;
                document.getElementById('usage-count').textContent = `${userData.usageCount} / ${userData.usageLimit}`;
                document.getElementById('user-plan').textContent = userData.plan.charAt(0).toUpperCase() + userData.plan.slice(1);
                document.getElementById('ai-credits').textContent = userData.aiCredits || 0;
                document.getElementById('modal-credits').textContent = userData.aiCredits || 0;
                
                const usagePercent = Math.min((userData.usageCount / userData.usageLimit) * 100, 100);
                document.getElementById('usage-bar').style.width = usagePercent + '%';
                
                if (usagePercent >= 90) {
                    document.getElementById('usage-bar').classList.add('bg-[#ff3b30]');
                    document.getElementById('usage-bar').classList.remove('bg-[#34c759]');
                }
            }
        }
        
        function toggleUserDropdown(show = null) {
            const dropdown = document.getElementById('user-dropdown');
            if (show === false) dropdown.classList.remove('show');
            else if (show === true) dropdown.classList.add('show');
            else dropdown.classList.toggle('show');
        }
        
        async function signOut() {
            try {
                await auth.signOut();
                showToast('Signed out successfully', 'success');
                toggleUserDropdown(false);
                window.location.href = 'index.html';
            } catch (error) {
                showToast('Error signing out', 'error');
            }
        }
        
        document.addEventListener('click', (e) => {
            const dropdown = document.getElementById('user-dropdown');
            const loggedInButtons = document.getElementById('logged-in-buttons');
            if (!loggedInButtons.contains(e.target)) {
                dropdown.classList.remove('show');
            }
        });
        
        function setExtractionMode(mode) {
            extractionMode = mode;
            document.getElementById('mode-standard').classList.toggle('active', mode === 'standard');
            document.getElementById('mode-ai').classList.toggle('active', mode === 'ai');
            
            const description = document.getElementById('mode-description');
            if (mode === 'standard') {
                description.textContent = 'Standard extraction uses advanced pattern matching for invoices & bank statements worldwide. Works best with digital PDFs.';
            } else {
                description.textContent = 'AI-powered extraction uses Llama 4 Maverick for maximum accuracy. Uses 1 AI credit per extraction.';
            }
        }
        
        function openCreditsModal() {
            document.getElementById('credits-modal').classList.remove('hidden');
            document.getElementById('credits-modal').classList.add('flex');
        }
        
        function closeCreditsModal() {
            document.getElementById('credits-modal').classList.add('hidden');
            document.getElementById('credits-modal').classList.remove('flex');
        }
        
        function selectCreditOption(element, amount, price) {
            document.querySelectorAll('.credit-option').forEach(opt => opt.classList.remove('selected'));
            element.classList.add('selected');
            selectedCredits = { amount, price };
        }
        
        async function purchaseCredits() {
            if (!currentUser) {
                showToast('Please sign in first', 'error');
                return;
            }
            
            showToast(`Redirecting to payment for ${selectedCredits.amount} credits ($${selectedCredits.price})...`, 'success');
            
            setTimeout(async () => {
                const userRef = db.collection('users').doc(currentUser.uid);
                await userRef.update({
                    aiCredits: firebase.firestore.FieldValue.increment(selectedCredits.amount)
                });
                await loadUserDataForDropdown(currentUser.uid);
                closeCreditsModal();
                showToast(`${selectedCredits.amount} AI credits added!`, 'success');
            }, 1500);
        }
        
        // File Upload Handling
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('file-input');
        
        uploadArea.addEventListener('click', () => fileInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) handleFileSelect(files[0]);
        });
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) handleFileSelect(e.target.files[0]);
        });
        
        function handleFileSelect(file) {
            if (file.type !== 'application/pdf') {
                showToast('Please upload a PDF file', 'error');
                return;
            }
            
            if (file.size > 50 * 1024 * 1024) {
                showToast('File size must be less than 50MB', 'error');
                return;
            }
            
            selectedFile = file;
            document.getElementById('file-name').textContent = file.name;
            document.getElementById('file-size').textContent = formatFileSize(file.size);
            document.getElementById('file-info').classList.remove('hidden');
            document.getElementById('extract-btn').classList.remove('hidden');
        }
        
        function clearFile() {
            selectedFile = null;
            pdfTextItems = [];
            pdfFullText = '';
            fileInput.value = '';
            document.getElementById('file-info').classList.add('hidden');
            document.getElementById('extract-btn').classList.add('hidden');
        }
        
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }
        
        function updateProgress(percent, status) {
            document.getElementById('progress-bar').style.width = percent + '%';
            document.getElementById('processing-status').textContent = status;
        }
        
        // Main Extraction Function
        async function extractDocument() {
            if (!currentUser) {
                showToast('Please sign in to extract documents', 'error');
                setTimeout(() => window.location.href = 'index.html#pricing', 2000);
                return;
            }
            
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            const userData = userDoc.data();
            
            if (extractionMode === 'ai') {
                const aiCredits = userData.aiCredits || 0;
                if (aiCredits < 1) {
                    showToast('No AI credits remaining. Purchase more or use standard mode.', 'error');
                    openCreditsModal();
                    return;
                }
            } else {
                if (userData.usageCount >= userData.usageLimit && userData.plan !== 'enterprise') {
                    showToast('You\'ve reached your plan limit. Please upgrade.', 'error');
                    setTimeout(() => window.location.href = 'index.html#pricing', 2000);
                    return;
                }
            }
            
            document.getElementById('upload-section').classList.add('hidden');
            document.getElementById('processing-section').classList.remove('hidden');
            
            try {
                updateProgress(10, 'Reading PDF content...');
                
                const arrayBuffer = await selectedFile.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                
                pdfTextItems = [];
                let fullText = '';
                
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    
                    textContent.items.forEach(item => {
                        if (item.str && item.str.trim()) {
                            pdfTextItems.push({
                                text: item.str,
                                x: Math.round(item.transform[4]),
                                y: Math.round(item.transform[5]),
                                width: item.width,
                                height: item.height,
                                page: i
                            });
                        }
                    });
                    
                    const pageText = textContent.items.map(i => i.str).join(' ');
                    fullText += pageText + '\n';
                }
                
                pdfFullText = fullText;
                
                updateProgress(30, 'Detecting document type...');
                
                // Detect document type
                const docType = detectDocumentType(fullText);
                console.log('Detected document type:', docType);
                
                updateProgress(50, extractionMode === 'ai' ? 'Analyzing with Llama 4 Maverick...' : 'Extracting data...');
                
                if (extractionMode === 'ai') {
                    extractedData = await extractWithAI(fullText, docType);
                    await db.collection('users').doc(currentUser.uid).update({
                        aiCredits: firebase.firestore.FieldValue.increment(-1)
                    });
                } else {
                    if (docType === 'bank_statement') {
                        extractedData = extractBankStatement(pdfTextItems, fullText);
                    } else {
                        extractedData = extractInvoiceEnhanced(pdfTextItems, fullText);
                    }
                    await incrementUsage(currentUser.uid);
                }
                
                extractedData.document_type = docType;
                
                updateProgress(90, 'Formatting results...');
                await loadUserDataForDropdown(currentUser.uid);
                
                updateProgress(100, 'Complete!');
                setTimeout(() => {
                    displayResults(extractedData);
                    document.getElementById('processing-section').classList.add('hidden');
                    document.getElementById('results-section').classList.remove('hidden');
                    document.getElementById('extraction-mode-label').textContent = 
                        extractionMode === 'ai' ? 'AI-powered extraction (Llama 4)' : 'Standard extraction';
                    showToast('Document extracted successfully!', 'success');
                }, 500);
                
            } catch (error) {
                console.error('Extraction error:', error);
                document.getElementById('processing-section').classList.add('hidden');
                document.getElementById('error-section').classList.remove('hidden');
                document.getElementById('error-message').textContent = error.message || 'Failed to extract data.';
            }
        }

        // ============================================
        // DOCUMENT TYPE DETECTION
        // ============================================
        function detectDocumentType(text) {
            const lowerText = text.toLowerCase();
            
            let bankScore = 0;
            let invoiceScore = 0;
            
            // Check bank statement keywords
            BANK_STATEMENT_KEYWORDS.forEach(keyword => {
                if (lowerText.includes(keyword.toLowerCase())) {
                    bankScore += keyword.split(' ').length; // Multi-word matches score higher
                }
            });
            
            // Check invoice keywords
            INVOICE_KEYWORDS.forEach(keyword => {
                if (lowerText.includes(keyword.toLowerCase())) {
                    invoiceScore += keyword.split(' ').length;
                }
            });
            
            // Additional heuristics
            // Bank statements typically have many transaction-like patterns
            const transactionPattern = /\d{1,2}[\/\.\-]\d{1,2}[\/\.\-]\d{2,4}\s+.{5,50}\s+[\d,.\-]+/g;
            const transactionMatches = text.match(transactionPattern) || [];
            if (transactionMatches.length > 5) bankScore += 10;
            
            // Invoices typically have line items with quantities
            const lineItemPattern = /\d+\s*[xX×]\s*[\d,.]+|qty\s*:?\s*\d+|quantity\s*:?\s*\d+/gi;
            const lineItemMatches = text.match(lineItemPattern) || [];
            if (lineItemMatches.length > 0) invoiceScore += 5;
            
            console.log(`Document type detection - Bank: ${bankScore}, Invoice: ${invoiceScore}`);
            
            return bankScore > invoiceScore ? 'bank_statement' : 'invoice';
        }

        // ============================================
        // LOCALE & FORMAT DETECTION
        // ============================================
        function detectNumberFormat(items) {
            const text = items.map(i => i.text).join(' ');
            
            // Count patterns
            let euroCount = (text.match(/\d{1,3}(?:\.\d{3})+,\d{2}/g) || []).length;  // 1.234,56
            let usCount = (text.match(/\d{1,3}(?:,\d{3})+\.\d{2}/g) || []).length;    // 1,234.56
            let swissCount = (text.match(/\d{1,3}(?:'\d{3})+\.\d{2}/g) || []).length; // 1'234.56
            let indianCount = (text.match(/\d{1,2}(?:,\d{2})+,\d{3}\.\d{2}/g) || []).length; // 1,23,456.78
            
            // Return detected format
            if (euroCount > usCount && euroCount > swissCount) return 'EU';
            if (swissCount > 0) return 'CH';
            if (indianCount > 0) return 'IN';
            return 'US';
        }

        function detectCurrency(text) {
            for (const [code, pattern] of Object.entries(CURRENCY_PATTERNS)) {
                if (pattern.test(text)) {
                    return code;
                }
            }
            return 'USD';
        }

        function parseNumber(str, format = 'US') {
            if (!str || typeof str !== 'string') return null;
            
            // Clean the string
            let clean = str.replace(/[^\d,.\-']/g, '');
            
            if (!clean || clean === '-') return null;
            
            switch (format) {
                case 'EU':
                    // 1.234,56 -> 1234.56
                    clean = clean.replace(/\./g, '').replace(',', '.');
                    break;
                case 'CH':
                    // 1'234.56 -> 1234.56
                    clean = clean.replace(/'/g, '');
                    break;
                case 'IN':
                    // 1,23,456.78 -> 123456.78
                    clean = clean.replace(/,/g, '');
                    break;
                case 'US':
                default:
                    // 1,234.56 -> 1234.56
                    clean = clean.replace(/,/g, '');
                    break;
            }
            
            const num = parseFloat(clean);
            return isNaN(num) ? null : num;
        }

        // ============================================
        // UNIVERSAL INVOICE EXTRACTION
        // ============================================
        function extractInvoice(items, fullText) {
            const format = detectNumberFormat(items);
            const currency = detectCurrency(fullText);
            const rows = buildRows(items);
            
            console.log(`Invoice extraction - Format: ${format}, Currency: ${currency}`);
            
            return {
                document_type: 'invoice',
                vendor_name: extractVendorName(rows, fullText),
                invoice_number: extractInvoiceNumber(rows, fullText),
                invoice_date: extractDate(rows, fullText, ['invoice date', 'date', 'datum', 'fecha', 'data', 'дата', '日期', '請求日']),
                due_date: extractDate(rows, fullText, ['due date', 'payment due', 'due by', 'fällig', 'échéance', 'vencimiento', 'scadenza']),
                po_number: extractPONumber(rows, fullText),
                customer_name: extractCustomerName(rows, fullText),
                subtotal: extractAmount(rows, fullText, format, ['subtotal', 'sub-total', 'net', 'netto', 'sous-total', 'importe neto', 'nettobetrag', '小計']),
                tax: extractAmount(rows, fullText, format, ['tax', 'vat', 'gst', 'hst', 'mwst', 'iva', 'tva', 'ндс', '消費税', '增值税', 'impuesto']),
                discount: extractAmount(rows, fullText, format, ['discount', 'rabatt', 'remise', 'descuento', 'sconto', '割引']),
                total: extractAmount(rows, fullText, format, ['total', 'grand total', 'amount due', 'balance due', 'gesamt', 'brutto', 'total ttc', 'importe total', '合計', '总计']),
                currency: currency,
                payment_terms: extractPaymentTerms(fullText),
                line_items: extractLineItems(rows, format)
            };
        }

        // ============================================
        // UNIVERSAL BANK STATEMENT EXTRACTION
        // ============================================
        function extractBankStatement(items, fullText) {
            const format = detectNumberFormat(items);
            const currency = detectCurrency(fullText);
            const rows = buildRows(items);
            
            console.log(`Bank statement extraction - Format: ${format}, Currency: ${currency}`);
            
            return {
                document_type: 'bank_statement',
                bank_name: extractBankName(rows, fullText),
                account_holder: extractAccountHolder(rows, fullText),
                account_number: extractAccountNumber(fullText),
                statement_period: extractStatementPeriod(rows, fullText),
                opening_balance: extractAmount(rows, fullText, format, ['opening balance', 'beginning balance', 'anfangssaldo', 'solde initial', 'saldo inicial', 'saldo iniziale', '期初余额', '期首残高']),
                closing_balance: extractAmount(rows, fullText, format, ['closing balance', 'ending balance', 'endsaldo', 'solde final', 'saldo final', 'saldo finale', '期末余额', '期末残高']),
                total_credits: extractAmount(rows, fullText, format, ['total credits', 'total deposits', 'gesamteinzahlungen', 'total crédit']),
                total_debits: extractAmount(rows, fullText, format, ['total debits', 'total withdrawals', 'gesamtauszahlungen', 'total débit']),
                currency: currency,
                transactions: extractTransactions(rows, format)
            };
        }

        // ============================================
        // HELPER EXTRACTION FUNCTIONS
        // ============================================
        function buildRows(items) {
            if (!items || items.length === 0) return [];
            
            const sorted = [...items].sort((a, b) => b.y - a.y || a.x - b.x);
            const rows = [];
            const yTolerance = 8;
            
            let currentRow = { y: sorted[0].y, items: [sorted[0]] };
            
            for (let i = 1; i < sorted.length; i++) {
                const item = sorted[i];
                if (Math.abs(item.y - currentRow.y) <= yTolerance) {
                    currentRow.items.push(item);
                } else {
                    currentRow.items.sort((a, b) => a.x - b.x);
                    currentRow.text = currentRow.items.map(t => t.text).join(' ');
                    rows.push(currentRow);
                    currentRow = { y: item.y, items: [item] };
                }
            }
            
            currentRow.items.sort((a, b) => a.x - b.x);
            currentRow.text = currentRow.items.map(t => t.text).join(' ');
            rows.push(currentRow);
            
            return rows;
        }

        function extractInvoiceEnhanced(items, fullText) {
            const format = detectNumberFormat(items);
            const currency = detectCurrency(fullText);
            const rows = buildRows(items);
            
            console.log('=== INVOICE EXTRACTION (STANDARD) ===');
            console.log('Format:', format, 'Currency:', currency);
            console.log('Full text preview:', fullText.substring(0, 500));
            
            const data = {
                document_type: 'invoice',
                vendor_name: extractVendorName(rows, fullText),
                invoice_number: extractInvoiceNumberEnhanced(items, fullText),
                invoice_date: extractDateEnhanced(items, fullText, ['invoice date', 'date', 'datum', 'fecha', 'data']),
                due_date: extractDateEnhanced(items, fullText, ['due date', 'payment due', 'due by', 'payable by', 'fällig', 'échéance']),
                po_number: extractPONumberEnhanced(items, fullText),
                customer_name: extractCustomerName(rows, fullText),
                subtotal: extractAmountEnhanced(items, fullText, format, ['subtotal', 'sub-total', 'sub total', 'net amount', 'netto']),
                tax: extractAmountEnhanced(items, fullText, format, ['tax', 'vat', 'gst', 'hst', 'sales tax', 'mwst', 'iva', 'tva']),
                discount: extractAmountEnhanced(items, fullText, format, ['discount', 'rabatt', 'remise', 'descuento']),
                total: extractAmountEnhanced(items, fullText, format, ['total due', 'amount due', 'total', 'grand total', 'balance due', 'gesamt']),
                currency: currency,
                payment_terms: extractPaymentTerms(fullText),
                line_items: extractLineItems(rows, format)
            };
            
            console.log('=== EXTRACTION RESULTS ===');
            console.log('Vendor:', data.vendor_name);
            console.log('Invoice #:', data.invoice_number);
            console.log('Invoice Date:', data.invoice_date);
            console.log('Due Date:', data.due_date);
            console.log('PO/Order #:', data.po_number);
            console.log('Subtotal:', data.subtotal);
            console.log('Tax:', data.tax);
            console.log('Total:', data.total);
            console.log('==========================');
            
            return data;
        }

        function extractVendorName(rows, fullText) {
            // Look for company name patterns at the top
            const companyPatterns = [
                /^([A-Z][A-Za-z0-9\s&.,'-]+(?:Inc\.?|LLC|Ltd\.?|GmbH|AG|S\.A\.?|S\.r\.l\.?|Pty|Plc|Co\.?|Corp\.?|BV|NV|AB|AS|Oy|ApS))/m,
                /^([A-Z][A-Za-z0-9\s&.,'-]{3,50})$/m
            ];
            
            // Check first 10 rows for company name
            for (let i = 0; i < Math.min(rows.length, 10); i++) {
                const text = (rows[i].text || '').trim();
                if (text.length < 3) continue;
                
                // Skip if it looks like a label
                if (/^(invoice|bill|rechnung|facture|date|from|to|ship|sold|customer|client|account)/i.test(text)) continue;
                
                for (const pattern of companyPatterns) {
                    const match = text.match(pattern);
                    if (match) return match[1].trim();
                }
                
                // If it's a substantial text without common labels, use it
                if (text.length > 5 && text.length < 100 && !/^\d+$/.test(text)) {
                    return text;
                }
            }
            
            return null;
        }

        function extractInvoiceNumberEnhanced(items, fullText) {
            console.log('Extracting invoice number from:', fullText.substring(0, 300));
            
            // Strategy 1: Find "Invoice Number" or similar label and get the value right after it
            const labelPatterns = [
                /(?:invoice|inv\.?|bill)\s+(?:number|no\.?|#|nr\.?)\s*[:=\-]?\s*([A-Z0-9][\w\-\/\.]+)/i,
                /(?:invoice|inv\.?|bill)\s*[:=\-]\s*([A-Z0-9][\w\-\/\.]{2,})/i,
                /(?:number|no\.?|nr\.?|#)\s*[:=\-]?\s*([A-Z0-9][\w\-\/\.]{3,})/i
            ];
            
            for (const pattern of labelPatterns) {
                const match = fullText.match(pattern);
                if (match && match[1]) {
                    const candidate = match[1].trim();
                    // Make sure it's not a common word
                    if (!/^(number|invoice|date|total|page|bill)$/i.test(candidate)) {
                        console.log('Found invoice number (label pattern):', candidate);
                        return candidate;
                    }
                }
            }
            
            // Strategy 2: Look for typical invoice number patterns
            const patternMatches = [
                /\b(INV[-\/]?\d{3,})\b/i,
                /\b([A-Z]{2,4}[-\/]\d{4,})\b/,
                /\b(\d{4,})\b/
            ];
            
            for (const pattern of patternMatches) {
                const match = fullText.match(pattern);
                if (match) {
                    console.log('Found invoice number (pattern):', match[1]);
                    return match[1];
                }
            }
            
            // Strategy 3: Spatial - look for items near "invoice" keyword
            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                const text = (item.text || '').toLowerCase();
                
                if (/invoice|inv\.?|bill/.test(text)) {
                    // Look at next few items (usually within 5 items to the right or below)
                    for (let j = i + 1; j < Math.min(i + 8, items.length); j++) {
                        const nextItem = items[j];
                        const nextText = (nextItem.text || '').trim();
                        
                        // Check if this looks like an invoice number
                        if (/^[A-Z0-9][\w\-\/\.]{2,}$/i.test(nextText) && 
                            !/^(number|no|nr|date|invoice|bill|page|total|amount)$/i.test(nextText) &&
                            nextText.length >= 3 && nextText.length <= 30) {
                            console.log('Found invoice number (spatial):', nextText);
                            return nextText;
                        }
                    }
                }
            }
            
            console.log('Invoice number not found');
            return null;
        }

        function extractDateEnhanced(items, fullText, keywords) {
            console.log(`Extracting date for keywords: ${keywords.join(', ')}`);
            
            // Date patterns
            const datePatterns = [
                /\b([A-Za-z]+\s+\d{1,2},?\s+\d{4})\b/,  // January 25, 2016
                /\b(\d{1,2}\s+[A-Za-z]+\s+\d{4})\b/,     // 25 January 2016
                /\b(\d{4}[-\/]\d{1,2}[-\/]\d{1,2})\b/,   // 2016-01-25
                /\b(\d{1,2}[-\/]\d{1,2}[-\/]\d{4})\b/,   // 01/25/2016
                /\b(\d{1,2}[-\/]\d{1,2}[-\/]\d{2})\b/    // 01/25/16
            ];
            
            // Strategy 1: Find keyword and extract date immediately after
            for (const keyword of keywords) {
                const regex = new RegExp(`${keyword}\\s*[:=\\-]?\\s*([A-Za-z]+\\s+\\d{1,2},?\\s+\\d{4}|\\d{1,2}\\s+[A-Za-z]+\\s+\\d{4}|\\d{4}[-\\/]\\d{1,2}[-\\/]\\d{1,2}|\\d{1,2}[-\\/]\\d{1,2}[-\\/]\\d{2,4})`, 'i');
                const match = fullText.match(regex);
                if (match && match[1]) {
                    console.log(`Found date for "${keyword}":`, match[1]);
                    return match[1].trim();
                }
            }
            
            // Strategy 2: Spatial - find keyword item and look at neighbors
            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                const text = (item.text || '').toLowerCase();
                
                // Check if this item contains any keyword
                const hasKeyword = keywords.some(kw => text.includes(kw.toLowerCase()));
                
                if (hasKeyword) {
                    // Look at next few items for a date
                    for (let j = i + 1; j < Math.min(i + 6, items.length); j++) {
                        const nextItem = items[j];
                        const nextText = nextItem.text || '';
                        
                        // Try to match date patterns
                        for (const pattern of datePatterns) {
                            const match = nextText.match(pattern);
                            if (match) {
                                console.log(`Found date (spatial) for "${keywords[0]}":`, match[1]);
                                return match[1];
                            }
                        }
                    }
                    
                    // Also check combined text of current and next items
                    const combinedText = items.slice(i, Math.min(i + 5, items.length))
                        .map(it => it.text || '')
                        .join(' ');
                    
                    for (const pattern of datePatterns) {
                        const match = combinedText.match(pattern);
                        if (match) {
                            console.log(`Found date (combined) for "${keywords[0]}":`, match[1]);
                            return match[1];
                        }
                    }
                }
            }
            
            console.log(`Date not found for keywords: ${keywords.join(', ')}`);
            return null;
        }

        function extractPONumberEnhanced(items, fullText) {
            console.log('Extracting PO/Order number');
            
            // Strategy 1: Label-based extraction
            const patterns = [
                /(?:order|purchase\s*order|p\.?o\.?)\s*(?:number|no\.?|#|nr\.?)?\s*[:=\-]?\s*([A-Z0-9][\w\-\/\.]+)/i,
                /(?:bestellung|orden|ordine|commande)\s*(?:nr\.?|#)?\s*[:=\-]?\s*([A-Z0-9][\w\-\/\.]+)/i
            ];
            
            for (const pattern of patterns) {
                const match = fullText.match(pattern);
                if (match && match[1]) {
                    const candidate = match[1].trim();
                    if (!/^(number|no|nr|order|date)$/i.test(candidate) && candidate.length >= 3) {
                        console.log('Found PO number:', candidate);
                        return candidate;
                    }
                }
            }
            
            // Strategy 2: Spatial - look for "order" keyword
            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                const text = (item.text || '').toLowerCase();
                
                if (/order|p\.?o\.?|purchase/.test(text) && !/invoice/.test(text)) {
                    // Look at nearby items
                    for (let j = i + 1; j < Math.min(i + 6, items.length); j++) {
                        const nextItem = items[j];
                        const nextText = (nextItem.text || '').trim();
                        
                        if (/^[A-Z0-9][\w\-\/\.]{2,}$/i.test(nextText) && 
                            !/^(number|no|nr|order|date)$/i.test(nextText) &&
                            nextText.length >= 3 && nextText.length <= 30) {
                            console.log('Found PO number (spatial):', nextText);
                            return nextText;
                        }
                    }
                }
            }
            
            return null;
        }

        function extractAmountEnhanced(items, fullText, format, keywords) {
            console.log(`Extracting amount for keywords: ${keywords.join(', ')}`);
            
            // Strategy 1: Find keyword and extract number immediately after
            for (const keyword of keywords) {
                // Create regex that captures currency symbol + number or just number
                const regex = new RegExp(`${keyword}\\s*[:=\\-]?\\s*([\\$£€¥₹]?\\s*[\\d,.']+)`, 'i');
                const match = fullText.match(regex);
                if (match && match[1]) {
                    const numStr = match[1].trim();
                    const parsed = parseNumber(numStr, format);
                    if (parsed !== null && parsed > 0) {
                        console.log(`Found amount for "${keyword}":`, parsed);
                        return parsed;
                    }
                }
            }
            
            // Strategy 2: Spatial - find keyword and look at nearby numbers
            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                const text = (item.text || '').toLowerCase();
                
                // Check if this item contains any keyword
                const hasKeyword = keywords.some(kw => text.includes(kw.toLowerCase()));
                
                if (hasKeyword) {
                    // Look at current row and next few items
                    const nearbyItems = items.slice(i, Math.min(i + 8, items.length));
                    
                    // Find all numbers in nearby items
                    const numbers = [];
                    nearbyItems.forEach(nearItem => {
                        const parsed = parseNumber(nearItem.text || '', format);
                        if (parsed !== null && parsed > 0 && parsed < 1000000) {
                            numbers.push({ value: parsed, x: nearItem.x });
                        }
                    });
                    
                    if (numbers.length > 0) {
                        // Return rightmost number (amounts usually on right side)
                        numbers.sort((a, b) => b.x - a.x);
                        console.log(`Found amount (spatial) for "${keywords[0]}":`, numbers[0].value);
                        return numbers[0].value;
                    }
                }
            }
            
            console.log(`Amount not found for keywords: ${keywords.join(', ')}`);
            return null;
        }

        function extractDate(rows, fullText, keywords) {
            const datePatterns = [
                /(\d{4}[-\/\.]\d{1,2}[-\/\.]\d{1,2})/,           // 2024-03-15
                /(\d{1,2}[-\/\.]\d{1,2}[-\/\.]\d{4})/,           // 15-03-2024
                /(\d{1,2}[-\/\.]\d{1,2}[-\/\.]\d{2})/,           // 15-03-24
                /((?:january|february|march|april|may|june|july|august|september|october|november|december|jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)[a-z]*\s+\d{1,2},?\s+\d{4})/i,  // January 25, 2016
                /(\d{1,2}\s+(?:january|february|march|april|may|june|july|august|september|october|november|december|jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)[a-z]*\s+\d{4})/i,  // 25 January 2016
            ];
            
            // Look for dates near keywords
            for (const row of rows) {
                const text = (row.text || '');
                const lowerText = text.toLowerCase();
                const hasKeyword = keywords.some(kw => lowerText.includes(kw.toLowerCase()));
                
                if (hasKeyword) {
                    for (const pattern of datePatterns) {
                        const match = text.match(pattern);
                        if (match && match[1]) return match[1].trim();
                    }
                }
            }
            
            // Fallback: search full text for dates
            for (const keyword of keywords) {
                const keywordRegex = new RegExp(`${keyword}[\\s:]*([A-Za-z0-9\\s,\\-\\/\\.]+)`, 'i');
                const match = fullText.match(keywordRegex);
                if (match) {
                    const potentialDate = match[1].trim();
                    // Try to extract date from this text
                    for (const pattern of datePatterns) {
                        const dateMatch = potentialDate.match(pattern);
                        if (dateMatch && dateMatch[1]) return dateMatch[1].trim();
                    }
                }
            }
            
            return null;
        }

        function extractAmount(rows, fullText, format, keywords) {
            // Search for amount near keywords with better tolerance
            for (const row of rows) {
                const text = (row.text || '').toLowerCase();
                const originalText = row.text || '';
                const hasKeyword = keywords.some(kw => text.includes(kw.toLowerCase()));
                
                if (hasKeyword) {
                    // Find all numbers in this row
                    const numbers = [];
                    row.items.forEach(item => {
                        const num = parseNumber(item.text, format);
                        if (num !== null && num > 0 && num < 1e9) {
                            numbers.push({ val: num, x: item.x, text: item.text });
                        }
                    });
                    
                    if (numbers.length > 0) {
                        // Return rightmost number (amounts usually on right)
                        numbers.sort((a, b) => b.x - a.x);
                        return numbers[0].val;
                    }
                    
                    // Try parsing from the row text directly
                    const amountMatch = originalText.match(/[\d,.']+/g);
                    if (amountMatch) {
                        for (let i = amountMatch.length - 1; i >= 0; i--) {
                            const num = parseNumber(amountMatch[i], format);
                            if (num !== null && num > 0) {
                                return num;
                            }
                        }
                    }
                }
            }
            
            // Fallback: search full text for keyword + amount pattern
            for (const keyword of keywords) {
                const patterns = [
                    new RegExp(`${keyword}[\\s:=\\-]*\\$?\\s*([\\d,.]+)`, 'i'),
                    new RegExp(`${keyword}[\\s:=\\-]*([\\d,.']+)`, 'i')
                ];
                
                for (const pattern of patterns) {
                    const match = fullText.match(pattern);
                    if (match && match[1]) {
                        const num = parseNumber(match[1], format);
                        if (num !== null && num > 0) {
                            return num;
                        }
                    }
                }
            }
            
            return null;
        }

        function extractPONumber(rows, fullText) {
            const patterns = [
                /(?:p\.?o\.?|purchase\s*order|order)\s*(?:no\.?|#|number)?\s*[:\-=]?\s*([A-Z0-9\-\/]{2,20})/i,
                /(?:bestellung|orden|ordine|commande)\s*(?:nr\.?|#)?\s*[:\-=]?\s*([A-Z0-9\-\/]{2,20})/i
            ];
            
            // Try to find in rows first
            for (const row of rows) {
                const text = row.text || '';
                if (/(?:order|p\.?o\.?|purchase)/i.test(text)) {
                    for (const pattern of patterns) {
                        const match = text.match(pattern);
                        if (match && match[1]) {
                            const num = match[1].trim();
                            if (!/^(number|no|nr|date)$/i.test(num)) {
                                return num;
                            }
                        }
                    }
                }
            }
            
            // Fallback to full text
            for (const pattern of patterns) {
                const match = fullText.match(pattern);
                if (match && match[1]) return match[1].trim();
            }
            return null;
        }

        function extractCustomerName(rows, fullText) {
            const patterns = [
                /(?:bill\s*to|sold\s*to|customer|client|kunde|client|cliente)[\s:]+([A-Za-z][A-Za-z0-9\s&.,'-]{3,50})/i
            ];
            
            for (const pattern of patterns) {
                const match = fullText.match(pattern);
                if (match) return match[1].trim();
            }
            return null;
        }

        function extractPaymentTerms(fullText) {
            const patterns = [
                /(?:payment\s*terms?|zahlungsbedingungen|conditions?\s*de\s*paiement|condiciones?\s*de\s*pago)[\s:]+([A-Za-z0-9\s,.-]{3,50})/i,
                /(?:net\s*\d+|due\s*(?:on|upon)\s*receipt|\d+\s*days?\s*(?:net)?)/i
            ];
            
            for (const pattern of patterns) {
                const match = fullText.match(pattern);
                if (match) return match[1] ? match[1].trim() : match[0].trim();
            }
            return null;
        }

        function extractBankName(rows, fullText) {
            const bankPatterns = [
                /\b([A-Z][A-Za-z\s]+(?:Bank|Banking|Savings|Credit Union|Sparkasse|Banque|Banco|Banca|銀行|银行))\b/,
                /\b(HSBC|Barclays|Deutsche Bank|BNP Paribas|Santander|ING|Citibank|Chase|Wells Fargo|Bank of America|Goldman Sachs|Morgan Stanley|UBS|Credit Suisse)\b/i
            ];
            
            for (let i = 0; i < Math.min(rows.length, 10); i++) {
                const text = rows[i].text || '';
                for (const pattern of bankPatterns) {
                    const match = text.match(pattern);
                    if (match) return match[1].trim();
                }
            }
            
            for (const pattern of bankPatterns) {
                const match = fullText.match(pattern);
                if (match) return match[1].trim();
            }
            
            return null;
        }

        function extractAccountHolder(rows, fullText) {
            const patterns = [
                /(?:account\s*holder|account\s*name|kontoinhaber|titulaire|titular|intestatario|名義人|账户名称)[\s:]+([A-Za-z][A-Za-z\s.,'-]{3,50})/i,
                /(?:name|naam|nom|nombre|nome)[\s:]+([A-Za-z][A-Za-z\s.,'-]{3,50})/i
            ];
            
            for (const pattern of patterns) {
                const match = fullText.match(pattern);
                if (match) return match[1].trim();
            }
            return null;
        }

        function extractAccountNumber(fullText) {
            const patterns = [
                /(?:account\s*(?:no\.?|number|#)|kontonummer|numéro\s*de\s*compte|cuenta|conto|口座番号|账号)[\s:]+([A-Z0-9\-\s]{6,30})/i,
                /(?:IBAN)[\s:]*([A-Z]{2}\d{2}[A-Z0-9\s]{10,30})/i,
                /\b([A-Z]{2}\d{2}[A-Z0-9]{10,28})\b/ // IBAN pattern
            ];
            
            for (const pattern of patterns) {
                const match = fullText.match(pattern);
                if (match) return match[1].replace(/\s+/g, '').trim();
            }
            return null;
        }

        function extractStatementPeriod(rows, fullText) {
            const patterns = [
                /(?:statement\s*period|period|zeitraum|période|periodo)[\s:]+(.{10,50})/i,
                /(?:from|von|du|de)\s*(\d{1,2}[\/.]\d{1,2}[\/.]\d{2,4})\s*(?:to|bis|au|a)\s*(\d{1,2}[\/.]\d{1,2}[\/.]\d{2,4})/i
            ];
            
            for (const pattern of patterns) {
                const match = fullText.match(pattern);
                if (match) {
                    if (match[2]) {
                        return `${match[1]} - ${match[2]}`;
                    }
                    return match[1].trim();
                }
            }
            return null;
        }

        function extractLineItems(rows, format) {
            const items = [];
            
            // Find header row
            const headerIndex = findHeaderRow(rows, ['description', 'item', 'product', 'service', 'bezeichnung', 'description', 'descripción', 'articolo', '品目', '品名']);
            
            if (headerIndex === -1) {
                return extractLineItemsHeuristic(rows, format);
            }
            
            const columns = analyzeColumnPositions(rows[headerIndex]);
            const stopKeywords = /^(subtotal|total|tax|vat|discount|shipping|net|gross|summe|合計|总计)/i;
            
            for (let i = headerIndex + 1; i < rows.length; i++) {
                const row = rows[i];
                const text = (row.text || '').trim();
                
                if (stopKeywords.test(text)) break;
                if (text.length < 3) continue;
                
                const item = parseLineItemRow(row, columns, format);
                if (item && (item.description || item.amount)) {
                    items.push(item);
                }
            }
            
            return items.slice(0, 100); // Limit to 100 items
        }

        function findHeaderRow(rows, keywords) {
            for (let i = 0; i < rows.length; i++) {
                const text = (rows[i].text || '').toLowerCase();
                let matchCount = 0;
                
                for (const kw of keywords) {
                    if (text.includes(kw.toLowerCase())) {
                        matchCount++;
                    }
                }
                
                // Also check for numeric column headers
                if (/qty|quantity|menge|quantité|cantidad|数量/.test(text)) matchCount++;
                if (/price|preis|prix|precio|価格|单价/.test(text)) matchCount++;
                if (/amount|betrag|montant|importe|金額|金额/.test(text)) matchCount++;
                
                if (matchCount >= 2) return i;
            }
            return -1;
        }

        function analyzeColumnPositions(headerRow) {
            const cols = { description: 0, quantity: null, unit_price: null, amount: null };
            
            headerRow.items.forEach(item => {
                const text = item.text.toLowerCase();
                if (/desc|item|product|service|bezeichnung|articolo|品目/.test(text)) {
                    cols.description = item.x;
                } else if (/qty|quantity|menge|quantité|cantidad|数量/.test(text)) {
                    cols.quantity = item.x;
                } else if (/unit|price|preis|prix|precio|単価|单价/.test(text)) {
                    cols.unit_price = item.x;
                } else if (/amount|total|betrag|montant|importe|金額|金额/.test(text)) {
                    cols.amount = item.x;
                }
            });
            
            return cols;
        }

        function parseLineItemRow(row, columns, format) {
            let description = '';
            let quantity = 1;
            let unit_price = null;
            let amount = null;
            
            const numbers = [];
            
            row.items.forEach(item => {
                const num = parseNumber(item.text, format);
                if (num !== null && num > 0) {
                    numbers.push({ val: num, x: item.x, text: item.text });
                } else {
                    // Collect non-numeric text as description
                    if (!/^[\d,.\-'\s]+$/.test(item.text.trim())) {
                        description += item.text + ' ';
                    }
                }
            });
            
            description = description.trim();
            
            if (numbers.length > 0) {
                // Sort by x position (left to right)
                numbers.sort((a, b) => a.x - b.x);
                
                // Heuristic: rightmost is amount, second-rightmost might be unit price
                amount = numbers[numbers.length - 1].val;
                
                if (numbers.length >= 2) {
                    unit_price = numbers[numbers.length - 2].val;
                }
                
                if (numbers.length >= 3) {
                    const potentialQty = numbers[0].val;
                    if (potentialQty >= 1 && potentialQty <= 9999 && Number.isInteger(potentialQty)) {
                        quantity = potentialQty;
                    }
                }
            }
            
            if (!description && !amount) return null;
            
            return { description, quantity, unit_price, amount };
        }

        function extractLineItemsHeuristic(rows, format) {
            const items = [];
            const amountPattern = /[\d,.]+/;
            
            for (const row of rows) {
                const text = row.text || '';
                
                // Skip headers and totals
                if (/^(description|item|qty|quantity|amount|total|subtotal|tax|invoice|bill)/i.test(text)) continue;
                
                // Look for rows with numbers that could be amounts
                const numbers = [];
                row.items.forEach(item => {
                    const num = parseNumber(item.text, format);
                    if (num !== null && num > 0.01 && num < 1e6) {
                        numbers.push(num);
                    }
                });
                
                if (numbers.length >= 1) {
                    const desc = text.replace(/[\d,.]+/g, '').trim();
                    if (desc.length > 2) {
                        items.push({
                            description: desc,
                            quantity: 1,
                            unit_price: numbers.length > 1 ? numbers[0] : null,
                            amount: numbers[numbers.length - 1]
                        });
                    }
                }
            }
            
            return items.slice(0, 50);
        }

        function extractTransactions(rows, format) {
            const transactions = [];
            const datePattern = /^\d{1,2}[\/\.\-]\d{1,2}(?:[\/\.\-]\d{2,4})?$/;
            
            // Find transaction header
            const headerIndex = findHeaderRow(rows, ['date', 'description', 'debit', 'credit', 'balance', 'datum', 'beschreibung', 'soll', 'haben', 'saldo']);
            
            const startIndex = headerIndex >= 0 ? headerIndex + 1 : 0;
            
            for (let i = startIndex; i < rows.length; i++) {
                const row = rows[i];
                const text = row.text || '';
                
                // Skip summary rows
                if (/^(total|opening|closing|balance|subtotal|summe)/i.test(text)) continue;
                
                // Look for date at the start
                const firstItem = row.items[0];
                if (!firstItem) continue;
                
                let date = null;
                let description = '';
                let debit = null;
                let credit = null;
                let balance = null;
                
                const numbers = [];
                
                row.items.forEach((item, idx) => {
                    const itemText = item.text.trim();
                    
                    // Check for date
                    if (idx === 0 && /\d{1,2}[\/\.\-]\d{1,2}/.test(itemText)) {
                        date = itemText;
                        return;
                    }
                    
                    // Check for number
                    const num = parseNumber(itemText, format);
                    if (num !== null) {
                        numbers.push({ val: num, x: item.x, text: itemText, isNegative: itemText.includes('-') || itemText.includes('(') });
                    } else if (!/^[\d,.\-'\s()]+$/.test(itemText)) {
                        description += itemText + ' ';
                    }
                });
                
                description = description.trim();
                
                if (!date && !description) continue;
                
                // Assign numbers to debit/credit/balance
                if (numbers.length === 1) {
                    balance = numbers[0].val;
                } else if (numbers.length === 2) {
                    if (numbers[0].isNegative || numbers[0].val < 0) {
                        debit = Math.abs(numbers[0].val);
                        balance = numbers[1].val;
                    } else {
                        credit = numbers[0].val;
                        balance = numbers[1].val;
                    }
                } else if (numbers.length >= 3) {
                    // Assume: debit, credit, balance (rightmost)
                    numbers.sort((a, b) => a.x - b.x);
                    debit = numbers[0].val > 0 ? numbers[0].val : null;
                    credit = numbers[1].val > 0 ? numbers[1].val : null;
                    balance = numbers[numbers.length - 1].val;
                }
                
                if (date || description || debit || credit) {
                    transactions.push({ date, description, debit, credit, balance });
                }
            }
            
            return transactions.slice(0, 500); // Limit to 500 transactions
        }

        // ============================================
        // AI EXTRACTION (Llama 4 Maverick)
        // ============================================
        async function extractWithAI(text, docType) {
            const systemPrompt = docType === 'bank_statement' 
                ? `You are an expert bank statement data extraction AI. Extract structured data from bank statements of any country or language.

Rules:
- Detect the number format (European: 1.234,56 vs US: 1,234.56) and convert all numbers to decimal format (1234.56)
- Extract all transactions with: date, description, debit, credit, balance
- Identify the bank name, account holder, account number (including IBAN)
- Extract opening and closing balances
- Detect currency from symbols or text

Return ONLY a valid JSON object with no markdown.`
                : `You are an expert invoice data extraction AI. Extract structured data from invoices of any country or language.

Rules:
- Detect the number format (European: 1.234,56 vs US: 1,234.56) and convert all numbers to decimal format (1234.56)
- Extract vendor name, invoice number, dates, amounts (subtotal, tax, discount, total)
- Extract all line items with: description, quantity, unit_price, amount
- Detect currency from symbols or text

Return ONLY a valid JSON object with no markdown.`;

            const userPrompt = docType === 'bank_statement'
                ? `Extract data from this bank statement and return ONLY a JSON object:

{
  "bank_name": "string or null",
  "account_holder": "string or null",
  "account_number": "string or null",
  "statement_period": "string or null",
  "opening_balance": number or null,
  "closing_balance": number or null,
  "total_credits": number or null,
  "total_debits": number or null,
  "currency": "USD",
  "transactions": [
    {"date": "string", "description": "string", "debit": number or null, "credit": number or null, "balance": number or null}
  ]
}

DOCUMENT TEXT:
${text.substring(0, 15000)}`
                : `Extract data from this invoice and return ONLY a JSON object:

{
  "vendor_name": "string or null",
  "invoice_number": "string or null",
  "invoice_date": "string or null",
  "due_date": "string or null",
  "po_number": "string or null",
  "customer_name": "string or null",
  "subtotal": number or null,
  "tax": number or null,
  "discount": number or null,
  "total": number or null,
  "currency": "USD",
  "payment_terms": "string or null",
  "line_items": [
    {"description": "string", "quantity": number, "unit_price": number, "amount": number}
  ]
}

DOCUMENT TEXT:
${text.substring(0, 15000)}`;

            try {
                const response = await fetch(GROQ_API_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${GROQ_API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: TEXT_MODEL,
                        messages: [
                            { role: 'system', content: systemPrompt },
                            { role: 'user', content: userPrompt }
                        ],
                        max_tokens: 8192,
                        temperature: 0.1
                    })
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                const result = await response.json();
                const content = result.choices?.[0]?.message?.content || '';
                
                return parseAIResponse(content, docType);
            } catch (error) {
                console.error('AI extraction error:', error);
                throw new Error(`AI extraction failed: ${error.message}`);
            }
        }

        function parseAIResponse(content, docType) {
            let jsonStr = content.trim();
            
            // Remove markdown code blocks
            if (jsonStr.includes('```')) {
                const match = jsonStr.match(/```(?:json)?\s*([\s\S]*?)```/);
                if (match) jsonStr = match[1].trim();
            }
            
            // Extract JSON object
            if (!jsonStr.startsWith('{')) {
                const match = jsonStr.match(/\{[\s\S]*\}/);
                if (match) jsonStr = match[0];
            }
            
            try {
                return JSON.parse(jsonStr);
            } catch (e) {
                // Try to fix common issues
                jsonStr = jsonStr
                    .replace(/,\s*}/g, '}')
                    .replace(/,\s*]/g, ']')
                    .replace(/'/g, '"')
                    .replace(/:\s*undefined/g, ': null');
                
                return JSON.parse(jsonStr);
            }
        }

        // ============================================
        // DISPLAY RESULTS
        // ============================================
        function displayResults(data) {
            const isStatement = data.document_type === 'bank_statement';
            
            // Update badge
            const badge = document.getElementById('doc-type-badge');
            if (isStatement) {
                badge.className = 'doc-type-badge doc-type-statement';
                badge.innerHTML = '<svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4z"/></svg>Bank Statement';
            } else {
                badge.className = 'doc-type-badge doc-type-invoice';
                badge.innerHTML = '<svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4z"/></svg>Invoice';
            }
            
            // Format currency
            const formatCurrency = (value) => {
                if (value === null || value === undefined) return 'N/A';
                return new Intl.NumberFormat('en-US', { 
                    style: 'currency', 
                    currency: data.currency || 'USD' 
                }).format(value);
            };
            
            // Build details section
            let fields = [];
            
            if (isStatement) {
                document.getElementById('details-title').textContent = 'Statement Details';
                fields = [
                    { label: 'Bank Name', value: data.bank_name },
                    { label: 'Account Holder', value: data.account_holder },
                    { label: 'Account Number', value: data.account_number },
                    { label: 'Statement Period', value: data.statement_period },
                    { label: 'Opening Balance', value: data.opening_balance ? formatCurrency(data.opening_balance) : null },
                    { label: 'Closing Balance', value: data.closing_balance ? formatCurrency(data.closing_balance) : null, highlight: true },
                    { label: 'Total Credits', value: data.total_credits ? formatCurrency(data.total_credits) : null },
                    { label: 'Total Debits', value: data.total_debits ? formatCurrency(data.total_debits) : null }
                ];
            } else {
                document.getElementById('details-title').textContent = 'Invoice Details';
                fields = [
                    { label: 'Vendor Name', value: data.vendor_name },
                    { label: 'Invoice Number', value: data.invoice_number },
                    { label: 'Invoice Date', value: data.invoice_date },
                    { label: 'Due Date', value: data.due_date },
                    { label: 'PO/Order Number', value: data.po_number },
                    { label: 'Customer', value: data.customer_name },
                    { label: 'Payment Terms', value: data.payment_terms },
                    { label: 'Subtotal', value: data.subtotal ? formatCurrency(data.subtotal) : null },
                    { label: 'Tax', value: data.tax ? formatCurrency(data.tax) : null },
                    { label: 'Discount', value: data.discount ? formatCurrency(data.discount) : null },
                    { label: 'Total Amount', value: data.total ? formatCurrency(data.total) : null, highlight: true }
                ];
            }
            
            // Debug logging
            console.log('Display Data:', data);
            console.log('Filtered Fields:', fields.filter(f => f.value && f.value !== 'N/A'));
            
            document.getElementById('document-details').innerHTML = fields
                .filter(f => f.value && f.value !== 'N/A' && f.value !== null && f.value !== undefined)
                .map(f => `
                    <div class="flex justify-between p-3 bg-white rounded-lg ${f.highlight ? 'border-2 border-[#34c759]' : ''}">
                        <span class="text-sm ${f.highlight ? 'font-semibold' : ''} text-[#6e6e73]">${f.label}</span>
                        <span class="text-sm font-semibold ${f.highlight ? 'text-lg text-[#34c759]' : ''}">${f.value}</span>
                    </div>
                `).join('');
            
            // Build items/transactions table
            const itemsSection = document.getElementById('items-section');
            const itemsTitle = document.getElementById('items-title');
            const thead = document.getElementById('items-thead');
            const tbody = document.getElementById('items-tbody');
            
            if (isStatement && data.transactions && data.transactions.length > 0) {
                itemsSection.classList.remove('hidden');
                itemsTitle.textContent = `Transactions (${data.transactions.length})`;
                
                thead.innerHTML = `
                    <tr class="border-b border-gray-300">
                        <th class="text-left text-xs font-semibold text-[#86868b] pb-3">Date</th>
                        <th class="text-left text-xs font-semibold text-[#86868b] pb-3">Description</th>
                        <th class="text-right text-xs font-semibold text-[#86868b] pb-3">Debit</th>
                        <th class="text-right text-xs font-semibold text-[#86868b] pb-3">Credit</th>
                        <th class="text-right text-xs font-semibold text-[#86868b] pb-3">Balance</th>
                    </tr>
                `;
                
                tbody.innerHTML = data.transactions.map(tx => `
                    <tr class="transaction-row border-b border-gray-200">
                        <td class="py-2 text-sm">${tx.date || '-'}</td>
                        <td class="py-2 text-sm max-w-xs truncate">${tx.description || '-'}</td>
                        <td class="py-2 text-sm text-right transaction-debit">${tx.debit ? formatCurrency(tx.debit) : '-'}</td>
                        <td class="py-2 text-sm text-right transaction-credit">${tx.credit ? formatCurrency(tx.credit) : '-'}</td>
                        <td class="py-2 text-sm text-right font-medium">${tx.balance ? formatCurrency(tx.balance) : '-'}</td>
                    </tr>
                `).join('');
            } else if (!isStatement && data.line_items && data.line_items.length > 0) {
                itemsSection.classList.remove('hidden');
                itemsTitle.textContent = `Line Items (${data.line_items.length})`;
                
                thead.innerHTML = `
                    <tr class="border-b border-gray-300">
                        <th class="text-left text-xs font-semibold text-[#86868b] pb-3">Description</th>
                        <th class="text-right text-xs font-semibold text-[#86868b] pb-3">Qty</th>
                        <th class="text-right text-xs font-semibold text-[#86868b] pb-3">Unit Price</th>
                        <th class="text-right text-xs font-semibold text-[#86868b] pb-3">Amount</th>
                    </tr>
                `;
                
                tbody.innerHTML = data.line_items.map(item => `
                    <tr class="border-b border-gray-200">
                        <td class="py-3 text-sm">${item.description || '-'}</td>
                        <td class="py-3 text-sm text-right">${item.quantity || '-'}</td>
                        <td class="py-3 text-sm text-right">${item.unit_price ? formatCurrency(item.unit_price) : '-'}</td>
                        <td class="py-3 text-sm text-right font-semibold">${item.amount ? formatCurrency(item.amount) : '-'}</td>
                    </tr>
                `).join('');
            } else {
                itemsSection.classList.add('hidden');
            }
        }
        
        async function incrementUsage(userId) {
            const userRef = db.collection('users').doc(userId);
            const userDoc = await userRef.get();
            
            if (userDoc.exists) {
                const data = userDoc.data();
                if (new Date() > data.usageResetDate.toDate()) {
                    await userRef.update({
                        usageCount: 1,
                        usageResetDate: getNextMonthDate()
                    });
                } else {
                    await userRef.update({
                        usageCount: firebase.firestore.FieldValue.increment(1)
                    });
                }
            }
        }
        
        function getNextMonthDate() {
            const now = new Date();
            return new Date(now.getFullYear(), now.getMonth() + 1, 1);
        }
        
        function resetExtractor() {
            clearFile();
            extractedData = null;
            document.getElementById('results-section').classList.add('hidden');
            document.getElementById('error-section').classList.add('hidden');
            document.getElementById('upload-section').classList.remove('hidden');
            document.getElementById('progress-bar').style.width = '0%';
        }
        
        // Download Functions
        function downloadCSV() {
            if (!extractedData) return;
            
            const isStatement = extractedData.document_type === 'bank_statement';
            let csv = '';
            
            if (isStatement) {
                csv += 'Bank Statement Export\n\n';
                csv += `Bank Name,${extractedData.bank_name || ''}\n`;
                csv += `Account Holder,${extractedData.account_holder || ''}\n`;
                csv += `Account Number,${extractedData.account_number || ''}\n`;
                csv += `Statement Period,${extractedData.statement_period || ''}\n`;
                csv += `Opening Balance,${extractedData.opening_balance || ''}\n`;
                csv += `Closing Balance,${extractedData.closing_balance || ''}\n`;
                csv += `Currency,${extractedData.currency || 'USD'}\n\n`;
                
                if (extractedData.transactions && extractedData.transactions.length > 0) {
                    csv += 'Transactions\nDate,Description,Debit,Credit,Balance\n';
                    extractedData.transactions.forEach(tx => {
                        csv += `"${tx.date || ''}","${(tx.description || '').replace(/"/g, '""')}",${tx.debit || ''},${tx.credit || ''},${tx.balance || ''}\n`;
                    });
                }
            } else {
                csv += 'Invoice Export\n\n';
                csv += `Vendor Name,"${(extractedData.vendor_name || '').replace(/"/g, '""')}"\n`;
                csv += `Invoice Number,${extractedData.invoice_number || ''}\n`;
                csv += `Invoice Date,${extractedData.invoice_date || ''}\n`;
                csv += `Due Date,${extractedData.due_date || ''}\n`;
                csv += `Subtotal,${extractedData.subtotal || ''}\n`;
                csv += `Tax,${extractedData.tax || ''}\n`;
                csv += `Discount,${extractedData.discount || ''}\n`;
                csv += `Total,${extractedData.total || ''}\n`;
                csv += `Currency,${extractedData.currency || 'USD'}\n\n`;
                
                if (extractedData.line_items && extractedData.line_items.length > 0) {
                    csv += 'Line Items\nDescription,Quantity,Unit Price,Amount\n';
                    extractedData.line_items.forEach(item => {
                        csv += `"${(item.description || '').replace(/"/g, '""')}",${item.quantity || ''},${item.unit_price || ''},${item.amount || ''}\n`;
                    });
                }
            }
            
            const filename = isStatement 
                ? `bank-statement-${extractedData.account_number || 'export'}.csv`
                : `invoice-${extractedData.invoice_number || 'export'}.csv`;
            
            downloadFile(csv, filename, 'text/csv');
            showToast('CSV downloaded!', 'success');
        }
        
        function downloadExcel() {
            if (!extractedData) return;
            
            const isStatement = extractedData.document_type === 'bank_statement';
            let tsv = '';
            
            if (isStatement) {
                tsv += 'Bank Statement Export\n\n';
                tsv += `Bank Name\t${extractedData.bank_name || ''}\n`;
                tsv += `Account Holder\t${extractedData.account_holder || ''}\n`;
                tsv += `Account Number\t${extractedData.account_number || ''}\n`;
                tsv += `Statement Period\t${extractedData.statement_period || ''}\n`;
                tsv += `Opening Balance\t${extractedData.opening_balance || ''}\n`;
                tsv += `Closing Balance\t${extractedData.closing_balance || ''}\n`;
                tsv += `Currency\t${extractedData.currency || 'USD'}\n\n`;
                
                if (extractedData.transactions && extractedData.transactions.length > 0) {
                    tsv += 'Transactions\nDate\tDescription\tDebit\tCredit\tBalance\n';
                    extractedData.transactions.forEach(tx => {
                        tsv += `${tx.date || ''}\t${tx.description || ''}\t${tx.debit || ''}\t${tx.credit || ''}\t${tx.balance || ''}\n`;
                    });
                }
            } else {
                tsv += 'Invoice Export\n\n';
                tsv += `Vendor Name\t${extractedData.vendor_name || ''}\n`;
                tsv += `Invoice Number\t${extractedData.invoice_number || ''}\n`;
                tsv += `Invoice Date\t${extractedData.invoice_date || ''}\n`;
                tsv += `Due Date\t${extractedData.due_date || ''}\n`;
                tsv += `Subtotal\t${extractedData.subtotal || ''}\n`;
                tsv += `Tax\t${extractedData.tax || ''}\n`;
                tsv += `Discount\t${extractedData.discount || ''}\n`;
                tsv += `Total\t${extractedData.total || ''}\n`;
                tsv += `Currency\t${extractedData.currency || 'USD'}\n\n`;
                
                if (extractedData.line_items && extractedData.line_items.length > 0) {
                    tsv += 'Line Items\nDescription\tQuantity\tUnit Price\tAmount\n';
                    extractedData.line_items.forEach(item => {
                        tsv += `${item.description || ''}\t${item.quantity || ''}\t${item.unit_price || ''}\t${item.amount || ''}\n`;
                    });
                }
            }
            
            const filename = isStatement 
                ? `bank-statement-${extractedData.account_number || 'export'}.xls`
                : `invoice-${extractedData.invoice_number || 'export'}.xls`;
            
            downloadFile(tsv, filename, 'application/vnd.ms-excel');
            showToast('Excel file downloaded!', 'success');
        }
        
        function downloadJSON() {
            if (!extractedData) return;
            
            const isStatement = extractedData.document_type === 'bank_statement';
            const json = JSON.stringify(extractedData, null, 2);
            
            const filename = isStatement 
                ? `bank-statement-${extractedData.account_number || 'export'}.json`
                : `invoice-${extractedData.invoice_number || 'export'}.json`;
            
            downloadFile(json, filename, 'application/json');
            showToast('JSON downloaded!', 'success');
        }
        
        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast flex items-center gap-3 px-6 py-4 rounded-2xl shadow-2xl ${
                type === 'success' ? 'bg-[#1d1d1f] text-white' : 'bg-[#ff3b30] text-white'
            }`;
            
            const icon = type === 'success' 
                ? '<svg class="w-5 h-5 text-[#34c759]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>'
                : '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>';
            
            toast.innerHTML = `${icon}<span class="text-sm font-medium">${message}</span>`;
            container.appendChild(toast);
            
            setTimeout(() => toast.remove(), 3000);
        }
    </script>
</body>
</html>
